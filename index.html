<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="width=device-width,initial-scale=1.0" name="viewport">
    <meta charset="utf-8">
    <title>.: vissom :.</title>

    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <script type="text/javascript" src="../lib/engine.io.js"></script>
    <script type="text/javascript">
        var 水 = {}; // TODO: remove soon
    </script>
    <script type="text/javascript" src="../lib/shui.deps.js"></script>
    <script type="text/javascript" src="../dist/shui.js"></script>
    <script type="text/javascript">
        var multicast = cosinedesign.toolbox.multicast;
    </script>
    <script type="text/javascript">
        var toolbox = cosinedesign.toolbox,
        delimiter = "|",
        socket;
        // register motion handlers

        sway.oninitialized = multicast(function (res) {
        var channel = state.channel = res.channel;
        var plugin = channel[channel.plugin];
        var orientation = plugin.orientation;
        var inputConfig = plugin.input;

        //sway.management.getTimer();

        // TODO: need a 'smoothing' pipe entry. Should accept a variance / threshold to stick to. Or maybe max delta?
        // shui pipe should:
        //  - throttle and/or smooth
        //  -
        // orientation pipe
        var oPipe = toolbox.pipe(showObject);

        //oPipe.next(showObject);
        socket = state.socket = new sway.Socket({ address: inputConfig.address + ':' + inputConfig.port });
        socket.connect();

        oPipe.add(shui.pipeline.buildHandlersForInput(shui.pipeline.plugins, 'scale', orientation));

        // add a send-to-sway-realtime handler/pipe
        var sendPipe = toolbox.pipe(function (data) {
        // translate the data first into the socket packet
        // TODO: make a more-compressed packet ... but for now...
        socket.send(channel.name + delimiter + data.alpha + delimiter + data.beta + delimiter + data.gamma );
        //var packet = { channel: channel.name, orientation: data };
        //socket.send(packet);
        return data;
        });
        sendPipe.next(showData);

        // add a throttle for sPipe
        var throttle = toolbox.throttle(sendPipe);
        throttle.interval(50);
        // add the pipe to
        oPipe.next(throttle);

        // TODO: add a timing handler
        // TODO: add an output handler

        function showData(o) {
        var out = "<br>"
        + "Channel " + channel.name + "</br>"
        + "alpha (yaw) " + o.alpha + "</br>"
        + "beta (pitch) " + o.beta + "</br>"
        + "gamma (roll) " + o.gamma + "</br>"
        + "absolute " + o.absolute + "</br>"
        + "</div>";

        divOutput.innerHTML = out;
        return o;
        }

        function clearData(o) {
        divOutput.innerHTML = '';
        return o;
        }
        function showObject(o) {
        divInput.innerHTML = JSON.stringify(o);
        return o;
        }



        // register pipe as motion handler
        shui.motion.onOrientation = oPipe;

        // initialize motion
        // TODO: Should this be in an oninitialize event?
        shui.motion.init();

        //sway.management.updateTimer();

        });

        sway.config.url = 'http://192.168.1.10:1000';

        // new calibrate action
        sway.actions.calibrate = function (data) {
        // generate a position within space
        var space = {
        x: { min: 100, max: 240 },
        y: { min: -20, max: 75 }
        };

        var spaceXSize = space.x.max - space.x.min;
        var spaceXIntervals = spaceXSize / 10;
        // take sway user id and multiply that by some increment within space x
        var targetX = spaceXIntervals * sway.user.channel.realtime.output.id;

        // send generated position (one ping only, please)
        socket.send(channel.name + delimiter + data.alpha + delimiter + data.beta + delimiter + data.gamma );

        // TODO: Make calibrate notification visible

        // TODO: assign onClick of button to handler

        };

        // initialize sway (connects to server)
        sway.init();

        // initialize sway-realtime

        // initialize shui pipeline

        // Sway needs to send us config information on what data we're sending, and where.
        // event->throttle->transform->send
        function createPipeline(dataConfig) {

        }

        sway.actions = {
            // Show the splashscreen for the installation
            "splash": function () {
                clientState.changeState('splash');
            },
            // Show intro message
            "intro": function () {},
            // Confirm user wants to join
            "confirm": function () {},
            // Select shape for the user
            "shape": function () {},
            // Calibrate user into the system
            "calibrate": function (data) {
            },
            // Notify user that they are waiting
            "queue": function () {},
            // Enter play state
            "play": function () {},
            // Quit the interation
            "quit": function () {}
        };
    </script>


<section id="splash" class="current-state">
    <header><svg class="logo"><use xlink:href="vissom-logo.svg#logo"></use></svg></header>

    <h1>Welcome to Visualize Somerville 2</h1>

    <nav>
        <button onclick="clientState.changeState('info')">Want to learn more?</button>
        <button onclick="clientState.changeState('queue')">Want to play?</button>
    </nav>
</section>

<section id="info" class="info">
    <article>
        <p>Imagine the feeling you get when you hold an ice cube tight, that combination of sting and ache, except imagine it all over your nearly nude body. Battling my long-­ingrained instincts never to run at a swimming pool, I fell into a kind of brisk walk-trot, aiming for the large set of interconnected hot tubs in the center of the complex. I’m sure I looked ridiculous. The good news: I’d never been less concerned about my appearance while wearing almost nothing in public.</p>

        <p>Small snowflakes glittered in the sky, which at 4 p.m. was already darkening toward dusk. I reached the largest hot tub and sank to my chin. For one glorious moment, I felt my mind go blank: There was just my body, my big, stupid body in its stupid bathing suit, enveloped in warmth, the cold wind on my ears only heightening my delight.</p>
    </article>

    <nav><button onclick="clientState.changeState('splash')">Continue</button></nav>
</section>

<section id="queue" class="queue">
    <article>
        <p>There are a few people ahead of you right now. You are number</p>
        <div class="queue--number">5</div>
        <p>in line. We will get you painting as soon as we can!</p>
    </article>

    <button onclick="clientState.changeState('calibration')">dummy button to calibration</button>
</section>

<section id="calibration">
    <header><div class="fpo">user shape</div></header>
    <article>
        <p>Okay! Let's get your device calibrated.</p>
        <p>Please point your phone at the shape shown above and then click the button below.</p>
    </article>
    <nav><button onclick="clientState.changeState('confirm')">Continue</button></nav>
</section>

<section id="confirm">
    <article>
        <p>Okay! We have calibrated your phone. The crosshair shows you where your brush is. Your shape is:</p>

        <div style="display: flex; justify-content: center;"><div class="fpo">user shape</div></div>

        <p>To paint: click and hold the <strong>paint</strong> button to create!</p>
    </article>
    <nav><button onclick="clientState.changeState('play')">Let's start!</button></nav>
</section>

<section id="play" class="play">
    <nav>
        <button onclick="clientState.changeState('quit')">Disconnect</button>
        <button onclick="clientState.changeState('calibration')">Recalibrate</button>
    </nav>

    <article><button class="control active">Hold to paint</button></article>

    <div class="user--shape">
        <div>Your shape:</div>
        <div class="fpo"></div>
    </div>

    <div class="control fpo">Dot size (slider control)</div>

</section>

<section id="disco">
    <p>You've been disconnected due to inactivity. Thanks for playing!</p>

    <svg class="logo"><use xlink:href="vissom-logo.svg#logo"></use></svg>
    <nav>
        <button onclick="clientState.changeState('info')">Want to learn more?</button>
        <button onclick="clientState.changeState('queue')">Want to play again?</button>
    </nav>
    </section>

<section id="quit">
    <nav>
        <button onclick="clientState.changeState('info')">Want to learn more?</button>
        <button onclick="clientState.changeState('queue')">Want to play again?</button>
    </nav>
</section>

<script type="text/javascript" src="js/viewController.js"></script>

</body>
</html>