<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="width=device-width,initial-scale=1.0" name="viewport">
    <meta charset="utf-8">
    <title>.: vissom :.</title>

    <link rel="stylesheet" href="css/main.css">
    <!--<link rel="manifest" href="manifest.json">-->
</head>
<body>
    <script type="text/javascript" src="lib/engine.io.js"></script>
    <script type="text/javascript">
        var æ°´ = {}; // TODO: remove soon
    </script>
    <script type="text/javascript" src="lib/shui.deps.js"></script>
    <script type="text/javascript" src="lib/shui.js"></script>
    <script type="text/javascript">
        var multicast = cosinedesign.toolbox.multicast;
    </script>
    <script type="text/javascript">

        var toolbox = cosinedesign.toolbox,
            calibration = {
                alphaOffset: 0
            },
            channel,
            delimiter = "|",
            oPipe,
            socket,
            state = {
                paint: false // set to true for active painting
            };
            sway.config.url = 'http://192.168.1.10:1000';

        function paint() {
            if (channel) {
                socket.send(channel.name + delimiter + 'active' + delimiter + state.paint);
            }
            state.paint = !state.paint;
        }

        function correctCompass(o) {
            o.heading = o.webkitCompassHeading || o.alpha;
            return o;
        }

        function showDebugData(el, o) {
            var out = "<br>"
                    + "alpha (yaw) " + o.alpha + "</br>"
                    + "beta (pitch) " + o.beta + "</br>"
                    + "gamma (roll) " + o.gamma + "</br>"
                    + "absolute " + o.absolute + "</br>";

            if (o.heading) {
                out = out + "heading " + o.heading + "</br>"
            }
            if (o.webkitCompassHeading) {
                out = out + "compass " + o.webkitCompassHeading + "</br>"
            }
            out += "</div>";

            el.innerHTML = out;
            return o;
        }

        // register motion handlers
        sway.oninitialized = multicast(function (res) {
            // TODO: if the user is not in a channel this crashes!
            if (!res.channel) {
                alert('user is not in a channel!');
                return;
            }
            else {
                channel = state.channel = res.channel;
                var plugin = channel[channel.plugin];
                var orientation = plugin.orientation;
                var inputConfig = plugin.input;
            }
            //sway.management.getTimer();

            // TODO: need a 'smoothing' pipe entry. Should accept a variance / threshold to stick to. Or maybe max delta?
            // shui pipe should:
            //  - throttle and/or smooth
            //  -

            //oPipe.next(showObject);
            socket = state.socket = new sway.Socket({address: inputConfig.address + ':' + inputConfig.port});
            socket.connect();

            // orientation pipe
            oPipe = toolbox.pipe(showObject);
            oPipe.add(shui.pipeline.buildHandlersForInput(shui.pipeline.plugins, 'scale', orientation));
            oPipe.add(shui.pipeline.buildHandlersForInput(shui.pipeline.plugins, 'ratioPolar', orientation));

            // add a send-to-sway-realtime handler/pipe
            var sendPipe = toolbox.pipe(function (data) {
                if (!data) return;
                // translate the data first into the socket packet
                socket.send(channel.name + delimiter + data.alpha + delimiter + data.beta + delimiter + data.gamma);
                //var packet = { channel: channel.name, orientation: data };
                //socket.send(packet);
                return data;
            });

            //sendPipe.next(showData);
            // add a throttle for sPipe
            var throttle = toolbox.throttle(sendPipe);
            throttle.interval(40);
            // add the pipe to
            oPipe.next(throttle);

            // TODO: add a timing handler
            // TODO: add an output handler

            function showData(o) {
                var out = "<br>"
                        + "Channel " + channel.name + "</br>"
                        + "alpha (yaw) " + o.alpha + "</br>"
                        + "beta (pitch) " + o.beta + "</br>"
                        + "gamma (roll) " + o.gamma + "</br>"
                        + "absolute " + o.absolute + "</br>"
                        + "</div>";

                divOutput.innerHTML = out;
                return o;
            }

            function clearData(o) {
                divOutput.innerHTML = '';
                return o;
            }

            function showObject(o) {
                //divInput.innerHTML = JSON.stringify(o);
                return o;
            }

            // register pipe as motion handler
            //shui.motion.onOrientation = oPipe;

            // initialize motion
            // TODO: Should this be in an oninitialize event?
            shui.motion.init();
            //sway.management.updateTimer();
            //alert('end initialized');
        });

        // new calibrate action
        // sway.actions.calibrate = function (data) {};

        // initialize sway (connects to server)

        sway.init();
        // initialize sway-realtime

        // initialize shui pipeline

        // Sway needs to send us config information on what data we're sending, and where.
        // event->throttle->transform->send
//        function createPipeline(dataConfig) {
//
//        }

        /**
         * Click handler - walk user through calibration steps
         */

        var calibrationViews;

        function calibrateViewNext () {
            var c = calibrationViews;
            switch (c.currentStep) {
                case 'step1':
                    calibration.heading1 = calibration.alpha;
                    // TODO: show next position (send position message to sway)
                    c.steps.step1.classList.remove('current-step');
                    c.steps.step2.classList.add('current-step');
                    c.currentStep = 'step2';
                    break;
                case 'step2':
                    calibration.heading2 = calibration.alpha;
                        // TODO: calc & show next position - heading90
                    c.steps.step2.classList.remove('current-step');
                    c.steps.step3.classList.add('current-step');
                    c.currentStep = 'step3';
                    break;
                case 'step3':
                        // TODO: record heading90 offset
                    clientState.changeView('confirm');
                    c.steps.step3.classList.remove('current-step');
                    c.steps.step1.classList.add('current-step');
                    sway.actions.calibrateComplete();
                    c.currentStep = 'step1';
            }
        }

        sway.actions = {
            // Show the splashscreen for the installation
            "splash": function () {
                calibrationViews = {
                    debugAlpha: document.getElementById('debugAlpha'),
                    currentStep: 'step1',
                    steps: {
                        step1: document.getElementById('calibrate1'),
                        step2: document.getElementById('calibrate2'),
                        step3: document.getElementById('calibrate3')
                    }
                };
                clientState.changeView('splash');
                //alert('splash viewable');
            },
            // Show info message
            "info": function () {
                clientState.changeView('info');
            },
            // Confirm user wants to join
            "confirm": function () {
                clientState.changeView('confirm');
            },
            // Select shape for the user
            //"shape": function () {},
            // Calibrate user into the system
            "calibrate": function (data) {
                // generate a position within space
                var space = {
                    x: { min: 100, max: 240 },
                    y: { min: -20, max: 75 }
                };

                var spaceXSize = space.x.max - space.x.min;
                var spaceXIntervals = spaceXSize / 10;
                // take sway user id and multiply that by some increment within space x
                var targetX = spaceXIntervals * sway.user.channel.realtime.output.id;

                // send generated position (one ping only, please)
                socket.send(state.channel.name + delimiter + targetX + delimiter + 45 + delimiter + 0 );

                // Make calibrate notification visible
                clientState.changeView('calibrate');

                // add a pipe specific to calibration
                var calPipe = toolbox.pipe(function (o) {
                    correctCompass(o);
                    showDebugData(calibrationViews.debugAlpha, o);
                    //.innerText = o.alpha;
                    calibration.alpha = o.alpha;
                    return o;
                });

                shui.motion.onOrientation = calPipe;
            },
            "calibrateComplete": function () {
                // Cut off the motion handler so the last value is now the calibration info.
                shui.motion.onOrientation = function () {};
                clientState.changeView('queue');
            },
            // Calibration
            // - we put one shape onscreen at targetX1; record that angle.
            // - we put same shape at targetX2; record that angle.

            // Notify user that they are waiting
            "queue": function () {
                //clientState.changeView('queue');
            },
            // Enter play state
            "play": function () {
                clientState.changeView('play');
                // Now assign the play pipe to the orientation handler
                shui.motion.onOrientation = oPipe;
            },
            // Quit the interation
            "quit": function () {
                clientState.changeView('quit');
            }
        };
    </script>


<section id="splash" class="splash current-state">
    <header><svg class="logo"><use xlink:href="vissom-logo.svg#logo"></use></svg></header>

    <h1>Welcome to Visualize Somerville 2</h1>

    <nav>
        <button onclick="clientState.changeView('info')">Want to learn more?</button>
        <button onclick="sway.actions.play()">Want to play?</button>
    </nav>
</section>

<section id="info" class="info">
    <article>
        <p>Visualize Somerville 2 (#VisSom2) combines technology, activity, and community into a large scale interactive installation. This event was hatched by the group <strong>Optexture</strong>, a thinktank of dreamers, coders, makers, and futurists.</p>

        <p>We created Visualize Somerville last year, and this year have upped the ante by providing interactivity for all participants.</p>

        <p><em>Visualize Somerville 2 is the attempt to disrupt our views of current-day technology.</em></p>

        <p>Everyone uses their personal devices, Ipads, smartphones, to keep connected like never before. But this also has a downside, as we also get lost in our own world and forget the world around you. How many of us have turned to our phones when we are traveling? Nervous?</p>

        <p>Visualize Somerville 2 takes that device, and brings new meaning to it: direct involvement and collaboration with the climbers, other painters, and the art you create as a collective.</p>

        <p>This is also a Masters Capstone project for a member of Optexture (Jon MacLeod). Thank you for coming, and enjoy!</p>
    </article>

    <nav><button onclick="clientState.changeView('splash')">Continue</button></nav>
</section>

<section id="queue" class="queue">
    <article>
        <p>There are a few people ahead of you right now. You are number</p>

        <div class="waiting">
            <svg class="circular" viewBox="25 25 50 50">
                <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
            </svg>

            <div class="queue--number">5</div>
        </div>

        <p>in line. We will get you painting as soon as we can!</p>

    </article>

    <button onclick="sway.actions.calibrate()">dummy button to calibration</button>
</section>

<section id="calibrate" class="calibrate">
    <header>
        <svg class="shape"></svg>
    </header>

    <article id="calibrate1" class="current-step">
        <p>Let's get your device calibrated!</p>
        <p>Look on the wall and find the shape and color shown above. Point your device at the shape, and then click the button below.</p>
    </article>

    <article id="calibrate2">
        <p>Great! Let's calibrate to a second point.</p>
        <p>Find the shape on the wall, point at it, and then click the button.</p>
    </article>

    <article id="calibrate3">
        <p>Just one more to go!</p>
        <p>Please point your phone at your shape and then click the button below.</p>
    </article>

    <div id="debugAlpha"></div>
    <nav><button onclick="calibrateViewNext()">Continue</button></nav>
</section>

<section id="confirm">
    <article>
        <p>Okay! We have calibrated your phone. Remember, your color and shape is:</p>

        <div class="user-shape">
            <svg class="shape"></svg>
        </div>

        <p>To paint: click and hold the <strong>paint</strong> button to create!</p>
    </article>
    <nav><button onclick="clientState.changeView('play')">Let's start!</button></nav>
</section>

<section id="play" class="play">
    <nav>
        <button onclick="clientState.changeView('quit')">Disconnect</button>
        <button onclick="sway.actions.calibrate()">Recalibrate</button>
    </nav>

    <article><button class="control" onclick="paint()">Hold to paint</button></article>

    <div class="display-shape">
        <div>Your shape:</div>

        <div>
            <svg class="shape"></svg>
        </div>
    </div>


    <div class="control">
        <label for="dotSize">Dot Size</label>
        <input type="range" min="1" max="10" value="4" id="dotSize">
    </div>

</section>

<section id="disco" class="end">
    <header><svg class="logo"><use xlink:href="vissom-logo.svg#logo"></use></svg></header>

    <p>You've been disconnected due to inactivity. Thanks for playing with us!</p>

    <nav>
        <button onclick="clientState.changeView('info')">Want to learn more?</button>
        <button onclick="clientState.changeView('queue')">Want to play again?</button>
    </nav>
</section>

<section id="quit" class="end">
    <header><svg class="logo"><use xlink:href="vissom-logo.svg#logo"></use></svg></header>

    <p>That was awesome. Thanks for playing with us!</p>

    <nav>
        <button onclick="clientState.changeView('info')">Want to learn more?</button>
        <button onclick="clientState.changeView('queue')">Want to play again?</button>
    </nav>
</section>

<script type="text/javascript" src="js/viewController.js"></script>

<script>

    clientState.shapeHandler('star', '#f0f');

    var lockFunction =  window.screen.orientation.lock;

    lockFunction.call(window.screen.orientation, 'portrait');

</script>
</body>
</html>